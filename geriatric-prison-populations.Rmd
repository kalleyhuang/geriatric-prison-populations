---
title: "Geriatric Prison Populations"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(tidyverse)
```

```{r set_seed}
set.seed(12345)
```

```{r normal_distribution}
population <- 
  rnorm(n = 1000, mean = 26, sd = 3) %>% 
  enframe() %>% 
  select(value) %>% 
  rename(original_age = value) %>% 
  mutate(current_age = original_age, years_incarcerated = 0)

overall <-
  tibble(year = 1, total_population = nrow(population), 
         median_age = median(population$current_age)) %>% 
  mutate("< 18" = pull(count(filter(population, current_age < 19))),
         "19 - 29" = pull(count(filter(population, current_age >= 19 & current_age < 30))),
         "30 - 39" = pull(count(filter(population, current_age >= 30 & current_age < 40))),
         "40 - 49" = pull(count(filter(population, current_age >= 40 & current_age < 50))),
         "50 - 59" = pull(count(filter(population, current_age >= 50 & current_age < 60))),
         "60 - 69" = pull(count(filter(population, current_age >= 60 & current_age < 70))),
         "70 - 79" = pull(count(filter(population, current_age >= 70 & current_age < 80))),
         "80 - 89" = pull(count(filter(population, current_age >= 80 & current_age < 90))),
         "90 +" = pull(count(filter(population, current_age >= 90))))
```

```{r one_year}
one_year_population <- function(data) {
  # age & years incarcerated increases by 1
  data$current_age <- data$current_age + 1
  data$years_incarcerated <- data$years_incarcerated + 1
  
  # creates age group cohorts & randomly removes fraction based on cohort
  less_than_18 <- filter(data, current_age < 19)
  less_than_18 <- sample_frac(less_than_18, (1 - 0.0055))
  
  `19_to_29` <- filter(data, current_age >= 19 & current_age < 30)
  `19_to_29` <- sample_frac(`19_to_29`, (1 - 0.0022))
  
  `30_to_39` <- filter(data, current_age >= 30 & current_age < 40)
  `30_to_39` <- sample_frac(`30_to_39`, (1 - 0.0023))
  
  `40_to_49` <- filter(data, current_age >= 40 & current_age < 50)
  `40_to_49` <- sample_frac(`40_to_49`, (1 - 0.0025))
  
  `50_to_59` <- filter(data, current_age >= 50 & current_age < 60)
  `50_to_59` <- sample_frac(`50_to_59`, (1 - 0.0060))
  
  `60_to_69` <- filter(data, current_age >= 60 & current_age < 70)
  `60_to_69` <- sample_frac(`60_to_69`, (1 - 0.0162))
  
  `70_to_79` <- filter(data, current_age >= 70 & current_age < 80)
  `70_to_79` <- sample_frac(`70_to_79`, (1 - 0.0424))
  
  `80_to_89` <- filter(data, current_age >= 80 & current_age < 90)
  `80_to_89` <- sample_frac(`80_to_89`, (1 - 0.0519))
  
  over_90 <- filter(data, current_age >= 90)
  over_90 <- sample_frac(over_90, (1 - 0.1250))
  
  data <- do.call("rbind", list(less_than_18, `19_to_29`, `30_to_39`, `40_to_49`, `50_to_59`, 
                                `60_to_69`,`70_to_79`, `80_to_89`, over_90))
  
  # adds 1000 more
  incoming <- 
    rnorm(n = 1000, mean = 26, sd = 3) %>% 
    enframe() %>% 
    select(value) %>% 
    rename(original_age = value) %>% 
    mutate(current_age = original_age, years_incarcerated = 0)
  data <- rbind(data, incoming)
  
  # removes any observations with age greater than 100
  data <- data %>% 
    filter(current_age < 100)
}

one_year_overall <- function(data, p) {
    incoming <-
      tibble(year = last(data$year) + 1, total_population = nrow(p),
             median_age = median(p$current_age)) %>% 
        mutate("< 18" = pull(count(filter(p, current_age < 19))),
               "19 - 29" = pull(count(filter(p, current_age >= 19 & current_age < 30))),
               "30 - 39" = pull(count(filter(p, current_age >= 30 & current_age < 40))),
               "40 - 49" = pull(count(filter(p, current_age >= 40 & current_age < 50))),
               "50 - 59" = pull(count(filter(p, current_age >= 50 & current_age < 60))),
               "60 - 69" = pull(count(filter(p, current_age >= 60 & current_age < 70))),
               "70 - 79" = pull(count(filter(p, current_age >= 70 & current_age < 80))),
               "80 - 89" = pull(count(filter(p, current_age >= 80 & current_age < 90))),
               "90 +" = pull(count(filter(p, current_age >= 90))))
    data <- rbind(data, incoming)
}
```

```{r test}
population <- one_year_population(population)
overall <- one_year_overall(overall, population)

# extend 100 years until stable
test_population <- population
test_overall <- overall
for (i in 1:100) {
  test_population <- one_year_population(test_population)
  test_overall <- one_year_overall(test_overall, test_population)
}
```

```{r test_graphs}
ggplot(data = test_overall, mapping = aes(x = year, y = median_age)) +
  geom_line() +
  labs(title = "Median Age Over Time", x = "Year", y = "Median Age")

test_overall %>% 
  mutate(under_30 = (`19 - 29` + `< 18`) / total_population * 100, 
         over_60 = (`60 - 69` + `70 - 79` + `80 - 89` + `90 +`) / total_population * 100) %>% 
  select(year, under_30, over_60) %>% 
  ggplot(data = ., mapping = aes(x = year, group = 1)) +
  geom_line(mapping = aes(y = under_30, color = "under_30")) +
  geom_line(mapping = aes(y = over_60, color = "over_60")) +
  labs(title = "Percent Under 30 & Over 60 Over Time", x = "Year", y = "Count") +
  scale_color_discrete(name = "Age Group",
                       breaks = c("under_30", "over_60"), labels = c("Under 30", "Over 60"))

test_overall_long <- test_overall %>% 
  select(year, `< 18`:`90 +`) %>% 
  mutate(year = as.character(year)) %>% 
  pivot_longer(-year, names_to = "age_group", values_to = "count")

ggplot(data = test_overall_long, mapping = aes(x = year, y = count, fill = age_group)) +
  geom_bar(position = "stack", stat = "identity") +
  labs(title = "Age Groups Over Time", x = "Year", y = "Count") +
  scale_x_discrete(limits = c("1", "21", "41", "61", "81", "101")) +
  scale_fill_discrete(name = "Age Group",
                      breaks = c("< 18", "19 - 29", "30 - 39", "40 - 49", "50 - 59", "60 - 69",
                                 "70 - 79", "80 - 89", "90 +"))
```

```{r bar_race}
bar_race <- test_overall %>% 
  select(year, `< 18`:`90 +`) %>% 
  mutate(year = as.character(year)) %>% 
  pivot_longer(-year, names_to = "age_group", values_to = "count") %>% 
  pivot_wider(names_from = "year", values_from = "count")
```

```{r actual}
actual <- read.csv("populations.csv")
actual %>% 
  mutate(Under30 = (AgeUnder20 + Age20to29) / PrisonPopulation * 100, 
         Over60 = (Age60to69 + Age70to79 + Age80to89 + Age90over) / PrisonPopulation * 100) %>% 
  select(year, PrisonPopulation, Under30, Over60) %>% 
  ggplot(data = ., mapping = aes(x = year, group = 1)) +
  geom_line(mapping = aes(y = Under30, color = "Under30")) +
  geom_line(mapping = aes(y = Over60, color = "Over60")) +
  labs(title = "Actual Percent Under 30 & Over 60 Over Time", x = "Year", y = "Percent") +
  scale_color_discrete(name = "Age Group",
                       breaks = c("Under30", "Over60"), labels = c("Under 30", "Over 60"))

actual_long <- actual %>% 
  select(year, AgeUnder20:Age90over) %>% 
  mutate(year = as.character(year)) %>% 
  pivot_longer(-year, names_to = "age_group", values_to = "count")

actual_long %>% 
  filter(age_group != "AgeUnder20") %>% 
  ggplot(data = ., mapping = aes(x = year, y = count, fill = age_group)) +
  geom_col() +
  labs(title = "Actual Age Groups Over Time", x = "Year", y = "Count") +
  scale_x_discrete(limits = c("1979", "1984", "1989", "1994", "1999", "2004", "2009", "2014", 
                              "2020")) +
  expand_limits(y = c(0, 50000)) +
  scale_fill_discrete(name = "Age Group",
                      breaks = c("Age20to29", "Age30to39", "Age40to49", "Age50to59", 
                                 "Age60to69", "Age70to79", "Age80to89", "Age90over"),
                      labels = c("20 - 29", "30 - 39", "40 - 49", "50 - 59", "60 - 69",
                                 "70 - 79", "80 - 89", "90 +"))

test_overall_long %>% 
  filter(age_group != "< 18") %>% 
  ggplot(data = ., mapping = aes(x = year, y = count, fill = age_group)) +
  geom_col() +
  labs(title = "Age Groups Over Time", x = "Year", y = "Count") +
  scale_x_discrete(limits = c("19", "24", "29", "34", "39", "44", "49", "54", "59")) +
  expand_limits(y = c(0, 50000)) +
  scale_fill_discrete(name = "Age Group",
                      breaks = c("19 - 29", "30 - 39", "40 - 49", "50 - 59", "60 - 69",
                                 "70 - 79", "80 - 89", "90 +"))
```

```{r bjs}
national <- read.csv("bjs.csv")
national %>% 
  select(RPTYEAR, ADMITYR, AGEADMIT, AGEYREND) %>% 
  mutate(TIMEINC = RPTYEAR - ADMITYR) %>% 
  group_by(RPTYEAR) %>% 
  count(AGEYREND) %>% 
  na.omit() %>% 
  mutate(COUNT_THSNDS = n / 1000, PERCENT = n / sum(n) * 100) %>% 
  filter(AGEYREND == "(5) 55+ years") %>%
  select(RPTYEAR, PERCENT) %>% 
  ggplot(data = ., mapping = aes(x = RPTYEAR, y = PERCENT)) +
  geom_line() +
  expand_limits(y = c(0, 25))

test_overall %>% 
  mutate(over_55 = (`50 - 59` / 2 + `60 - 69` + `70 - 79` + `80 - 89` + `90 +`) / 
           total_population * 100) %>% 
  select(year, over_55) %>% 
  filter(year > 20 & year < 40) %>% 
  ggplot(data = ., mapping = aes(x = year, y = over_55)) +
  geom_line() +
  expand_limits(y = c(0, 25))

ggplot(data = national, mapping = aes(x = RPTYEAR, y = COUNT_THSNDS, fill = AGEYREND)) +
  geom_col()

ggplot(data = national, mapping = aes(x = RPTYEAR, y = PERCENT, fill = AGEYREND)) +
  geom_bar(stat = "identity")
```

```{r test_equilibrium}
test_population_e <- test_population
test_overall_e <- test_overall
for (i in 1:100) {
  test_population_e <- one_year_population(test_population_e)
  test_overall_e <- one_year_overall(test_overall_e, test_population_e)
}
```

```{r test_equilibrium_graphs}
ggplot(data = test_overall_e, mapping = aes(x = year, y = median_age)) +
  geom_line() +
  labs(title = "Median Age Over Time", x = "Year", y = "Median Age")

test_overall_e %>% 
  mutate(under_30 = (`19 - 29` + `< 18`) / total_population * 100, 
         over_60 = (`60 - 69` + `70 - 79` + `80 - 89` + `90 +`) / total_population * 100) %>% 
  select(year, under_30, over_60) %>% 
  ggplot(data = ., mapping = aes(x = year, group = 1)) +
  geom_line(mapping = aes(y = under_30, color = "under_30")) +
  geom_line(mapping = aes(y = over_60, color = "over_60")) +
  labs(title = "Percent Under 30 & Over 60 Over Time", x = "Year", y = "Count") +
  scale_color_discrete(name = "Age Group",
                       breaks = c("under_30", "over_60"), labels = c("Under 30", "Over 60"))

test_overall_e_long <- test_overall_e %>% 
  select(year, `< 18`:`90 +`) %>% 
  mutate(year = as.character(year)) %>% 
  pivot_longer(-year, names_to = "age_group", values_to = "count") %>% 
  filter(year == "1" | year == "21" | year == "41" | year == "61" | year == "81" | 
           year == "101" | year == "121" | year == "141" | year == "161" | year == "181" |
           year == "201")

ggplot(data = test_overall_e_long, mapping = aes(x = year, y = count, fill = age_group)) +
  geom_bar(position = "stack", stat = "identity") +
  labs(title = "Age Groups Over Time", x = "Year", y = "Count") +
  scale_x_discrete(limits = c("1", "21", "41", "61", "81", "101", "121", "141", "161", "181", 
                              "201")) +
  scale_fill_discrete(name = "Age Group",
                      breaks = c("< 18", "19 - 29", "30 - 39", "40 - 49", "50 - 59", "60 - 69",
                                 "70 - 79", "80 - 89", "90 +"))

bar_race_e <- test_overall_e %>% 
  select(year, `< 18`:`90 +`) %>% 
  mutate(year = as.character(year)) %>% 
  pivot_longer(-year, names_to = "age_group", values_to = "count") %>% 
  pivot_wider(names_from = "year", values_from = "count")
```

```{r parole_functions}
one_year_parole <- function(data) {
  # age & years incarcerated increases by 1
  data$current_age <- data$current_age + 1
  data$years_incarcerated <- data$years_incarcerated + 1
  
  # creates age group cohorts & randomly removes fraction based on cohort
  less_than_18 <- filter(data, current_age < 19)
  less_than_18 <- sample_frac(less_than_18, (1 - 0.0055))
  
  `19_to_29` <- filter(data, current_age >= 19 & current_age < 30)
  `19_to_29` <- sample_frac(`19_to_29`, (1 - 0.0022))
  
  `30_to_39` <- filter(data, current_age >= 30 & current_age < 40)
  `30_to_39` <- sample_frac(`30_to_39`, (1 - 0.0023))
  
  `40_to_49` <- filter(data, current_age >= 40 & current_age < 50)
  `40_to_49` <- sample_frac(`40_to_49`, (1 - 0.0025))
  
  `50_to_59` <- filter(data, current_age >= 50 & current_age < 60)
  `50_to_59` <- sample_frac(`50_to_59`, (1 - 0.0060))
  
  `60_to_69` <- filter(data, current_age >= 60 & current_age < 70)
  `60_to_69` <- sample_frac(`60_to_69`, (1 - 0.0162))
  
  `70_to_79` <- filter(data, current_age >= 70 & current_age < 80)
  `70_to_79` <- sample_frac(`70_to_79`, (1 - 0.0424))
  
  `80_to_89` <- filter(data, current_age >= 80 & current_age < 90)
  `80_to_89` <- sample_frac(`80_to_89`, (1 - 0.0519))
  
  over_90 <- filter(data, current_age >= 90)
  over_90 <- sample_frac(over_90, (1 - 0.1250))
  
  data <- do.call("rbind", list(less_than_18, `19_to_29`, `30_to_39`, `40_to_49`, `50_to_59`, 
                                `60_to_69`,`70_to_79`, `80_to_89`, over_90))
  
  eligible <- sample_frac(filter(data, years_incarcerated >= 20), 0.9)
  ineligible <- filter(data, years_incarcerated < 20)
  data <- rbind(eligible, ineligible)
  
  # adds 1000 more
  incoming <- 
    rnorm(n = 1000, mean = 26, sd = 3) %>% 
    enframe() %>% 
    select(value) %>% 
    rename(original_age = value) %>% 
    mutate(current_age = original_age, years_incarcerated = 0)
  data <- rbind(data, incoming)
  
  # removes any observations with age greater than 100
  data <- data %>% 
    filter(current_age < 100)
}
```

```{r test_parole}
parole_population <- population
parole_overall <- overall

for (i in 1:100) {
  parole_population <- one_year_parole(parole_population)
  parole_overall <- one_year_overall(parole_overall, parole_population)
}
```

```{r test_parole_graphs}
ggplot(data = parole_overall, mapping = aes(x = year, y = median_age)) +
  geom_line() +
  labs(title = "Median Age Over Time with Parole", x = "Year", y = "Median Age")

parole_overall %>% 
  mutate(under_30 = (`19 - 29` + `< 18`) / total_population * 100, 
         over_60 = (`60 - 69` + `70 - 79` + `80 - 89` + `90 +`) / total_population * 100) %>% 
  select(year, under_30, over_60) %>% 
  ggplot(data = ., mapping = aes(x = year, group = 1)) +
  geom_line(mapping = aes(y = under_30, color = "under_30")) +
  geom_line(mapping = aes(y = over_60, color = "over_60")) +
  labs(title = "Percent Under 30 & Over 60 Over Time with Parole", x = "Year", y = "Count") +
  scale_color_discrete(name = "Age Group",
                       breaks = c("under_30", "over_60"), labels = c("Under 30", "Over 60"))

parole_overall_long <- parole_overall %>% 
  select(year, `< 18`:`90 +`) %>% 
  mutate(year = as.character(year)) %>% 
  pivot_longer(-year, names_to = "age_group", values_to = "count")

ggplot(data = parole_overall_long, mapping = aes(x = year, y = count, fill = age_group)) +
  geom_bar(position = "stack", stat = "identity") +
  labs(title = "Age Groups Over Time with Parole", x = "Year", y = "Count") +
  scale_x_discrete(limits = c("1", "21", "41", "61", "81", "101")) +
  scale_fill_discrete(name = "Age Group",
                      breaks = c("< 18", "19 - 29", "30 - 39", "40 - 49", "50 - 59", "60 - 69",
                                 "70 - 79", "80 - 89", "90 +"))
```
